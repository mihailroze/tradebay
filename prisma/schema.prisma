generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingType {
  SALE
  TRADE
}

enum ListingStatus {
  ACTIVE
  SOLD
  HIDDEN
}

model User {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  displayName String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings Listing[]
}

model Game {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servers    Server[]
  categories Category[]
  tags       Tag[]
  listings   Listing[]
}

model Server {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  listings Listing[]

  @@unique([gameId, name])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")
  listings Listing[]

  @@unique([gameId, parentId, name])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  listings ListingTag[]

  @@unique([gameId, name])
}

model Listing {
  id           String        @id @default(cuid())
  title        String
  description  String?
  type         ListingType
  price        Decimal?      @db.Decimal(12, 2)
  currency     String?
  tradeNote    String?
  contactAlt   String?
  status       ListingStatus @default(ACTIVE)
  gameId       String
  serverId     String?
  categoryId   String?
  sellerId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  game      Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  server    Server?   @relation(fields: [serverId], references: [id], onDelete: SetNull)
  category  Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  seller    User      @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  images    Image[]
  tags      ListingTag[]

  @@index([gameId, serverId, categoryId, status])
  @@index([title])
}

model ListingTag {
  listingId String
  tagId     String

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([listingId, tagId])
  @@index([tagId])
}

model Image {
  id        String   @id @default(cuid())
  data      Bytes
  contentType String
  fileName  String?
  size      Int
  listingId String
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}
