generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ListingType {
  SALE
  TRADE
}

enum ListingStatus {
  ACTIVE
  SOLD
  HIDDEN
}

enum WalletTransactionType {
  TOP_UP
  PURCHASE
  SALE
  REFUND
}

enum WalletTransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  displayName String?
  lastSeenAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  listings  Listing[] @relation("ListingSeller")
  purchases Listing[] @relation("ListingBuyer")
  favorites ListingFavorite[]
  wallet    Wallet?
}

model Game {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servers    Server[]
  categories Category[]
  tags       Tag[]
  listings   Listing[]
}

model Server {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  listings Listing[]

  @@unique([gameId, name])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")
  listings Listing[]

  @@unique([gameId, parentId, name])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  gameId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game     Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  listings ListingTag[]

  @@unique([gameId, name])
}

model Listing {
  id           String        @id @default(cuid())
  title        String
  description  String?
  type         ListingType
  price        Decimal?      @db.Decimal(12, 2)
  currency     String?
  tradeNote    String?
  contactAlt   String?
  status       ListingStatus @default(ACTIVE)
  gameId       String
  serverId     String?
  categoryId   String?
  sellerId     String
  buyerId      String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  game      Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  server    Server?   @relation(fields: [serverId], references: [id], onDelete: SetNull)
  category  Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  seller    User      @relation("ListingSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  buyer     User?     @relation("ListingBuyer", fields: [buyerId], references: [id], onDelete: SetNull)
  images    Image[]
  tags      ListingTag[]
  favorites ListingFavorite[]
  walletTransactions WalletTransaction[]

  @@index([gameId, serverId, categoryId, status])
  @@index([title])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id        String                  @id @default(cuid())
  walletId  String
  type      WalletTransactionType
  status    WalletTransactionStatus @default(PENDING)
  amount    Int
  currency  String                  @default("TC")
  listingId String?
  externalId String?                @unique
  payload   String?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  wallet  Wallet  @relation(fields: [walletId], references: [id], onDelete: Cascade)
  listing Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([listingId])
  @@index([walletId, createdAt])
  @@index([payload])
}

model ListingFavorite {
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([userId, listingId])
  @@index([listingId])
}

model ListingTag {
  listingId String
  tagId     String

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([listingId, tagId])
  @@index([tagId])
}

model Image {
  id        String   @id @default(cuid())
  data      Bytes
  contentType String
  fileName  String?
  size      Int
  listingId String
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
}
